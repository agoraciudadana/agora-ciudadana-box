#!/bin/bash

# otherwise we get 'fatal: $HOME not set' when doing git config below
export HOME=/home/aelection
source $HOME/.profile

cd $HOME

[ ! -d $HOME/.virtualenvs/agora-election ] && mkvirtualenv agora-election -p $(which python3.3)

[ ! -d $HOME/agora-election ] && (git clone https://github.com/agoraciudadana/agora-election.git)

chmod +x $HOME/aelection_celery_launch.sh

cd $HOME
if [ ! -f  $HOME/agora-election/agora_election/settings.py ] || [ "<%= @overwrite_aelection_settings %>" == "true" ]
then
    mv $HOME/election.json $HOME/agora-election/agora_election/
    mv $HOME/faq.json $HOME/agora-election/agora_election/
    mv $HOME/custom_settings.py $HOME/agora-election/agora_election/custom_settings.py
fi

git config --global user.email "<%= @admin_email %>"
git config --global user.name "<%= @admin_name %>"

workon agora-election
cd $HOME/agora-election
git stash
git pull --rebase
git stash apply

pip install -r requirements.txt
pip install psycopg2 uwsgi

[ -d /var/www/aelection/static ] && rm -rf /var/www/aelection/static
mkdir -p /var/www/aelection/static
cp -rf /home/aelection/agora-election/agora_election/static/* /var/www/aelection/static
chown aelection:www-data -R /var/www/aelection/static

cd agora_election
./app.py --createdb